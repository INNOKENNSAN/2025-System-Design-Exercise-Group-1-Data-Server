name: Sync GitHub Issues to Notion

on:
  issues:
    types: [opened, edited, reopened, closed]

jobs:
  sync:
    runs-on: ubuntu-latest

    env:
      NOTION_TOKEN: "${{ secrets.NOTION_TOKEN }}"
      DATABASE_ID: "${{ secrets.NOTION_DB_ID }}"
      ISSUE_TITLE: "${{ github.event.issue.title }}"
      ISSUE_URL: "${{ github.event.issue.html_url }}"
      ISSUE_STATE: "${{ github.event.issue.state }}"
      ISSUE_NUMBER: "${{ github.event.issue.number }}"
      ISSUE_ASSIGNEES: "${{ join(github.event.issue.assignees.*.login, ', ') }}"

    steps:
      - name: Sync Issue
        run: |

          echo "=== Issue Info ==="
          echo "STATE=$ISSUE_STATE"
          echo "NUMBER=$ISSUE_NUMBER"

          # ------------------------------
          # 1. 既存ページ検索
          # ------------------------------
          RESPONSE=$(curl -s -X POST \
            "https://api.notion.com/v1/databases/$DATABASE_ID/query" \
            -H "Authorization: Bearer $NOTION_TOKEN" \
            -H "Content-Type: application/json" \
            -H "Notion-Version: 2022-06-28" \
            -d "{
              \"filter\": {
                \"property\": \"IssueID\",
                \"number\": {
                  \"equals\": $ISSUE_NUMBER
                }
              }
            }")

          PAGE_ID=$(echo $RESPONSE | jq -r '.results[0].id')

          if [ "$PAGE_ID" = "null" ]; then
            PAGE_ID=""
          fi

          echo "PAGE_ID=$PAGE_ID"

          # ------------------------------
          # 2. Closeされた場合 → アーカイブ
          # ------------------------------
          if [ "$ISSUE_STATE" = "closed" ]; then

            if [ -z "$PAGE_ID" ]; then
              echo "No page found. Nothing to archive."
              exit 0
            fi

            echo "Archiving page $PAGE_ID"

            curl -X PATCH \
              "https://api.notion.com/v1/pages/$PAGE_ID" \
              -H "Authorization: Bearer $NOTION_TOKEN" \
              -H "Content-Type: application/json" \
              -H "Notion-Version: 2022-06-28" \
              -d '{
                "archived": true
              }'

            exit 0
          fi

          # ------------------------------
          # 3. 既存ページがある → 更新
          # ------------------------------
          if [ -n "$PAGE_ID" ]; then

            echo "Updating page $PAGE_ID"

            curl -X PATCH \
              "https://api.notion.com/v1/pages/$PAGE_ID" \
              -H "Authorization: Bearer $NOTION_TOKEN" \
              -H "Content-Type: application/json" \
              -H "Notion-Version: 2022-06-28" \
              -d "{
                \"properties\": {
                  \"Name\": {
                    \"title\": [{
                      \"text\": { \"content\": \"$ISSUE_TITLE\" }
                    }]
                  },
                  \"URL\": { \"url\": \"$ISSUE_URL\" },
                  \"State\": {
                    \"select\": { \"name\": \"$ISSUE_STATE\" }
                  },
                  \"Assignees\": {
                    \"rich_text\": [{
                      \"text\": { \"content\": \"$ISSUE_ASSIGNEES\" }
                    }]
                  }
                }
              }"

            exit 0
          fi

          # ------------------------------
          # 4. ページがない → 新規作成
          # ------------------------------
          echo "Creating new page"

          curl -X POST https://api.notion.com/v1/pages \
            -H "Authorization: Bearer $NOTION_TOKEN" \
            -H "Content-Type: application/json" \
            -H "Notion-Version: 2022-06-28" \
            -d "{
              \"parent\": { \"database_id\": \"$DATABASE_ID\" },
              \"properties\": {
                \"Name\": {
                  \"title\": [{
                    \"text\": { \"content\": \"$ISSUE_TITLE\" }
                  }]
                },
                \"IssueID\": { \"number\": $ISSUE_NUMBER },
                \"URL\": { \"url\": \"$ISSUE_URL\" },
                \"State\": {
                  \"select\": { \"name\": \"$ISSUE_STATE\" }
                },
                \"Assignees\": {
                  \"rich_text\": [{
                    \"text\": { \"content\": \"$ISSUE_ASSIGNEES\" }
                  }]
                }
              }
            }"
