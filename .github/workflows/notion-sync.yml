name: Sync GitHub Issues to Notion

on:
  issues:
    types: [opened, edited, reopened, closed]

jobs:
  sync:
    runs-on: ubuntu-latest

    env:
      NOTION_TOKEN: "${{ secrets.NOTION_TOKEN }}"
      DATABASE_ID: "${{ secrets.NOTION_DB_ID }}"
      ISSUE_TITLE: "${{ github.event.issue.title }}"
      ISSUE_URL: "${{ github.event.issue.html_url }}"
      ISSUE_STATE: "${{ github.event.issue.state }}"
      ISSUE_NUMBER: "${{ github.event.issue.number }}"
      ISSUE_ASSIGNEES: "${{ join(github.event.issue.assignees.*.login, ', ') }}"

    steps:
      - name: Search existing page
        id: search
        run: |
          RESPONSE=$(curl -s -X POST https://api.notion.com/v1/databases/${DATABASE_ID}/query \
            -H "Authorization: Bearer ${NOTION_TOKEN}" \
            -H "Content-Type: application/json" \
            -H "Notion-Version: 2022-06-28" \
            -d '{
              "filter": {
                "property": "IssueID",
                "rich_text": {
                  "equals": "'"${ISSUE_NUMBER}"'"
                }
              }
            }')

          echo "$RESPONSE" > response.json

          PAGE_ID=$(jq -r '.results[0].id // empty' response.json)
          echo "PAGE_ID=$PAGE_ID" >> $GITHUB_ENV

      # ==============================
      # Issue closed → アーカイブ
      # ==============================
      - name: Archive page when closed
        if: env.ISSUE_STATE == 'closed' && env.PAGE_ID != ''
        run: |
          curl -X PATCH https://api.notion.com/v1/pages/${PAGE_ID} \
            -H "Authorization: Bearer ${NOTION_TOKEN}" \
            -H "Content-Type: application/json" \
            -H "Notion-Version: 2022-06-28" \
            -d '{
              "archived": true
            }'

      # ==============================
      # 更新処理（既存ページあり）
      # ==============================
      - name: Update existing page
        if: env.ISSUE_STATE != 'closed' && env.PAGE_ID != ''
        run: |
          curl -X PATCH https://api.notion.com/v1/pages/${PAGE_ID} \
            -H "Authorization: Bearer ${NOTION_TOKEN}" \
            -H "Content-Type: application/json" \
            -H "Notion-Version: 2022-06-28" \
            -d '{
              "properties": {
                "Name": {
                  "title": [
                    {
                      "text": {
                        "content": "'"${ISSUE_TITLE}"'"
                      }
                    }
                  ]
                },
                "URL": {
                  "url": "'"${ISSUE_URL}"'"
                },
                "State": {
                  "select": {
                    "name": "'"${ISSUE_STATE}"'"
                  }
                },
                "Assignees": {
                  "rich_text": [
                    {
                      "text": {
                        "content": "'"${ISSUE_ASSIGNEES}"'"
                      }
                    }
                  ]
                }
              }
            }'

      # ==============================
      # 新規作成（ページが存在しない）
      # ==============================
      - name: Create new page
        if: env.ISSUE_STATE != 'closed' && env.PAGE_ID == ''
        run: |
          curl -X POST https://api.notion.com/v1/pages \
            -H "Authorization: Bearer ${NOTION_TOKEN}" \
            -H "Content-Type: application/json" \
            -H "Notion-Version: 2022-06-28" \
            -d '{
              "parent": { "database_id": "'"${DATABASE_ID}"'" },
              "properties": {
                "Name": {
                  "title": [
                    {
                      "text": {
                        "content": "'"${ISSUE_TITLE}"'"
                      }
                    }
                  ]
                },
                "IssueID": {
                  "number": '"${ISSUE_NUMBER}"'
                },
                "URL": {
                  "url": "'"${ISSUE_URL}"'"
                },
                "State": {
                  "select": {
                    "name": "'"${ISSUE_STATE}"'"
                  }
                },
                "Assignees": {
                  "rich_text": [
                    {
                      "text": {
                        "content": "'"${ISSUE_ASSIGNEES}"'"
                      }
                    }
                  ]
                }
              }
            }'
