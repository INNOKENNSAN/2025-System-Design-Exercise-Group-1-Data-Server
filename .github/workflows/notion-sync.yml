name: Sync Issue to Notion

on:
  issues:
    types: [opened, edited, closed, reopened]

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Sync to Notion
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          DATABASE_ID: ${{ secrets.NOTION_DB_ID }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_URL: ${{ github.event.issue.html_url }}
          ISSUE_STATE: ${{ github.event.issue.state }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          # 既存ページ検索
          SEARCH_RESULT=$(curl -s -X POST https://api.notion.com/v1/databases/$DATABASE_ID/query \
            -H "Authorization: Bearer $NOTION_TOKEN" \
            -H "Content-Type: application/json" \
            -H "Notion-Version: 2022-06-28" \
            -d "{
              \"filter\": {
                \"property\": \"IssueID\",
                \"number\": {
                  \"equals\": $ISSUE_NUMBER
                }
              }
            }")

          PAGE_ID=$(echo $SEARCH_RESULT | jq -r '.results[0].id')

          if [ "$PAGE_ID" != "null" ]; then
            echo "Updating existing page"

            curl -X PATCH https://api.notion.com/v1/pages/$PAGE_ID \
              -H "Authorization: Bearer $NOTION_TOKEN" \
              -H "Content-Type: application/json" \
              -H "Notion-Version: 2022-06-28" \
              -d "{
                \"properties\": {
                  \"Name\": {
                    \"title\": [{
                      \"text\": { \"content\": \"$ISSUE_TITLE\" }
                    }]
                  },
                  \"State\": {
                    \"select\": { \"name\": \"${ISSUE_STATE^}\" }
                  }
                }
              }"

          else
            echo "Creating new page"

            curl -X POST https://api.notion.com/v1/pages \
              -H "Authorization: Bearer $NOTION_TOKEN" \
              -H "Content-Type: application/json" \
              -H "Notion-Version: 2022-06-28" \
              -d "{
                \"parent\": { \"database_id\": \"$DATABASE_ID\" },
                \"properties\": {
                  \"Name\": {
                    \"title\": [{
                      \"text\": { \"content\": \"$ISSUE_TITLE\" }
                    }]
                  },
                  \"IssueID\": {
                    \"number\": $ISSUE_NUMBER
                  },
                  \"URL\": {
                    \"url\": \"$ISSUE_URL\"
                  },
                  \"State\": {
                    \"select\": { \"name\": \"${ISSUE_STATE^}\" }
                  }
                }
              }"
          fi
